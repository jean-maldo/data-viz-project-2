<!DOCTYPE html>
<html>
<head>
    <title>Tsunamis and Their Causes</title>
    <meta charset="utf-8">
<style>
    body {
        background: #fcfcfa;
    }

    .stroke {
        fill: none;
        stroke: #000;
        stroke-width: 3px;
    }

    .fill {
        fill: #fff;
    }

    .graticule {
        fill: none;
        stroke: #777;
        stroke-width: .5px;
        stroke-opacity: .5;
    }

    .land {
        fill: #222;
    }

    .boundary {
        fill: none;
        stroke: #fff;
        stroke-width: .5px;
    }
</style>
</head>
<body>
    <div>
        <svg id="map_svg" height="550" width="960"></svg>
        <label for="hue_slider">Timeline: </label><input id="year_slider" type="range" min="1950" max="2007" value="1980"/>
    <div>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-geo-projection/2.1.0/d3-geo-projection.min.js"></script>
    <script src="http://d3js.org/topojson.v2.min.js"></script>
    <script>
        var length = 10,
    color = d3.scaleLinear().domain([1,length])
      .interpolate(d3.interpolateHcl)
      .range([d3.rgb("#C0C0C0"), d3.rgb('#F0F0F0')]);
        var tsunamis, earthquakes, volcanoes;
        var filteredYearsTsunamis, filteredYearsEarthquakes, filteredYearsVolcanoes;
        var map_svg = d3.select("#map_svg");
        var width_map = map_svg.attr("width");
        var height_map = map_svg.attr("height");

        function parseTsunamisEarthqaukes (line) {
            line.LATITUDE = Number(line.LATITUDE);
            line.LONGITUDE = Number(line.LONGITUDE);
            line.YEAR = Number(line.YEAR);
            return line;
        }
        
        function parseVolcanoes (line) {
            line.Latitude = Number(line.Latitude);
            line.Longitude = Number(line.Longitude);
            line.Year = Number(line.Year);
            return line;
        }
        
        var projection = d3.geoInterrupt(d3.geoRobinsonRaw, [
                [ // northern hemisphere
                    [
                        [-180, 0],
                        [-90, 90],
                        [0, 0]
                    ],
                    [
                        [0, 0],
                        [90, 90],
                        [180, 0]
                    ]
                ],
                [ // southern hemisphere
                    [
                        [-180, 0],
                        [-90, -90],
                        [0, 0]
                    ],
                    [
                        [0, 0],
                        [90, -90],
                        [180, 0]
                    ]
                ]
            ])
            .rotate([150, 0])
            .scale(145)
            .translate([width_map / 2, height_map / 2])
            .precision(.1);
            
        var path = d3.geoPath().projection(projection);

        var graticule = d3.geoGraticule();

        var defs = map_svg.append("defs");

        defs.append("path")
            .datum({
                type: "Sphere"
            })
            .attr("id", "sphere")
            .attr("d", path);

        defs.append("clipPath")
            .attr("id", "clip")
            .append("use")
            .attr("xlink:href", "#sphere");

        map_svg.append("use")
            .attr("class", "stroke")
            .attr("xlink:href", "#sphere");

        map_svg.append("use")
            .attr("class", "fill")
            .attr("xlink:href", "#sphere");

        map_svg.append("path")
            .datum(graticule)
            .attr("class", "graticule")
            .attr("clip-path", "url(#clip)")
            .attr("d", path);

        d3.queue()
            .defer(d3.json, "world-50m.json")
            .defer(d3.csv, "data/tsunami_events.csv", parseTsunamisEarthqaukes)
            .defer(d3.csv, "data/tsunami_earquake_events.csv", parseTsunamisEarthqaukes)
            .defer(d3.csv, "data/tsunami_volcano_events.csv", parseVolcanoes)
            .await(showVisualization);

        function showVisualization(error, data_map, data_tsunamis, data_earthquakes, data_volcanoes) {
            if (error) throw error;
            tsunamis = data_tsunamis;
            earthquakes = data_earthquakes;
            volcanoes = data_volcanoes;
            
            var countries = topojson.feature(data_map, data_map.objects.countries).features,
                neighbors = topojson.neighbors(data_map.objects.countries.geometries);

            map_svg.insert("path", ".graticule")
                .datum(topojson.feature(data_map, data_map.objects.land))
                .attr("class", "land")
                .attr("clip-path", "url(#clip)")
                .attr("d", path);

            map_svg.insert("path", ".graticule")
                .datum(topojson.mesh(data_map, data_map.objects.countries, function(a, b) {
                    return a !== b;
                }))
                .attr("class", "boundary")
                .attr("clip-path", "url(#clip)")
            

            map_svg.selectAll(".country")
                .data(countries)
                .enter().insert("path", ".graticule")
                .attr("class", "country")
                .attr("clip-path", "url(#clip)")
                .attr("d", path)
                .style("fill", function(d, i) {
                    return color(d.color = d3.max(neighbors[i], function(n) {
                        return countries[n].color;
                    }) + 1 | 0);
                });
            
            function showTsunamis(years) {
                filteredYearsTsunamis = data_tsunamis.filter(function (d) { return years.indexOf(d.YEAR) > 0; });
                
                var tsunami_points = map_svg.selectAll("circle.tsunami_points").data(filteredYearsTsunamis);
                
                tsunami_points.enter().append("circle").merge(tsunami_points)
                .attr("id", function (d, i) {
                    return "point" + i;
                })
                .attr("class", "tsunami_points")
                .attr("r", 3)
                .attr("cx", function (d) {
                    return projection([d.LONGITUDE, d.LATITUDE])[0];
                })
                .attr("cy", function (d) {
                    return projection([d.LONGITUDE, d.LATITUDE])[1];
                })
                .attr   ("fill", "blue")
                .style("opacity", 0.5);
            }
            
            function showEarthquakes(years) {
                filteredYearsEarthquakes = data_earthquakes.filter(function (d) { return years.indexOf(d.YEAR) > 0; });
                
                var earthquake_points = map_svg.selectAll("circle.earthquake_points").data(filteredYearsEarthquakes);
                    
                earthquake_points.enter().append("circle").merge(earthquake_points)
                .attr("id", function (d, i) {
                    return "point" + i;
                })
                .attr("class", "earthquake_points")
                .attr("r", 3)
                .attr("cx", function (d) {
                    return projection([d.LONGITUDE, d.LATITUDE])[0];
                })
                .attr("cy", function (d) {
                    return projection([d.LONGITUDE, d.LATITUDE])[1];
                })
                .attr   ("fill", "green")
                .style("opacity", 0.5);
            }
            
            function showVolcanoes(years) {
                filteredYearsVolcanoes = volcanoes.filter(function (d) { return years.indexOf(d.Year) > 0; });
                
                var volcano_points = map_svg.selectAll("circle.volcano_points").data(filteredYearsVolcanoes);
                
                volcano_points.enter().append("circle").merge(volcano_points)
                .attr("id", function (d, i) {
                    return "point" + i;
                })
                .attr("class", "volcano_points")
                .attr("r", 3)
                .attr("cx", function (d) {
                    return projection([d.Longitude, d.Latitude])[0];
                })
                .attr("cy", function (d) {
                    return projection([d.Longitude, d.Latitude])[1];
                })
                .attr   ("fill", "red")
                .style("opacity", 0.5);
            }
            
            function showDisasters(years) {
                showTsunamis(years);
                showEarthquakes(years);
                showVolcanoes(years);
            }
            
            d3.select("#year_slider")
                .on("input", function () {
                    var slider_year = Number(this.value);
                    var yearsToFilter = [slider_year];
                    
                    for(var i = 0; i < 10; i++) {
                        yearsToFilter.push(slider_year + i);
                    }
                    
                    showDisasters(yearsToFilter);
                });
                    
        }
    </script>
    </body>
</html>


